#!/bin/bash

set -e


# Check OVPN_DIR for a server configuration
if [ -z ${OVPN_DIR+x} ]; then
	echo Error: OVPN_DIR variable is required. && exit 1
fi
if [ ! -d $OVPN_DIR ]; then
	echo $OVPN_DIR not found! && exit 1
fi
if [[ ! -e $OVPN_DIR/server.conf ]]; then
	# The config dir hasn't been initialized
	# Run the install script real quick
	openvpn_install
fi


export IMAGE="dockerlabvpn_vpn"

if [ -z ${IMAGE+x} ]; then
	echo Error: IMAGE variable is required. && exit 1
fi


# Check for the pki configuration
if [ ! -d $OVPN_DIR/easy-rsa ]; then
	# The easy-rsa dir hasn't been initialized

	if [ "$1" != "openvpn_initpki" ]; then
		# Let the user know that they need to run the initpki script
		echo -e "PKI configuration not found. You can initialize it now by running:\n"
		echo -e "docker run --rm --volumes-from $OVPN_DATA -it $IMAGE openvpn_initpki\n"
		echo -e "(Or you can just map in $OVPN_DIR/easy-rsa using a volume?)"
		exit 1
	fi
fi


# Check for the tunnel device
if [ ! -d /dev/net ]; then
	mkdir -p /dev/net
fi
if [ ! -c /dev/net/tun ]; then
	mknod /dev/net/tun c 10 200
fi


# Run the given CMD
exec "$@"

